<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Breaker: 100ì¸µì˜ ë„ì „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/gh/Dalgona/neodgm/neodgm.css" rel="stylesheet">
    <style>
        body { font-family: 'NeoDunggeunmo', sans-serif; background-color: #202020; }
        
        /* ë ˆíŠ¸ë¡œ í”½ì…€ í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
        .retro-border {
            box-shadow: 
                -4px 0 0 0 white,
                4px 0 0 0 white,
                0 -4px 0 0 white,
                0 4px 0 0 white;
            margin: 4px;
            border: 4px solid #2d3748;
        }
        
        .retro-btn:active {
            transform: translateY(2px);
            filter: brightness(0.9);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #374151; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; border: 2px solid #374151; }
        
        /* ë˜ì „ ë°°ê²½ íŒ¨í„´ */
        .dungeon-bg {
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(335deg, rgba(255,255,255,0.05) 23px, transparent 23px),
                linear-gradient(155deg, rgba(255,255,255,0.05) 23px, transparent 23px);
            background-size: 58px 58px;
        }

        .hp-fill { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .text-mythic { color: #dc2626; text-shadow: 1px 1px 0 #000; } 
        .text-legendary { color: #d97706; text-shadow: 1px 1px 0 #000; } 
        .text-epic { color: #7c3aed; text-shadow: 1px 1px 0 #fff; } 
        .text-rare { color: #2563eb; } 
        .text-common { color: #374151; } 
    </style>
</head>
<body class="text-[#2c2c2c] select-none h-screen flex items-center justify-center overflow-hidden">

    <div id="app" class="w-full h-full flex items-center justify-center bg-[#1a1a1a]">
        </div>

    <script>
        // --- ì•„ì´ì½˜ ì •ì˜ ---
        // Lucide ì•„ì´ì½˜ ë¡œë“œ í™•ì¸
        window.ICONS = {
            sword: 'sword', shield: 'shield', heart: 'heart', zap: 'zap', 
            skull: 'skull', trendingUp: 'trending-up', refreshCw: 'refresh-cw',
            trophy: 'trophy', target: 'target', sparkles: 'sparkles',
            user: 'user', alert: 'alert-triangle', flame: 'flame',
            repeat: 'repeat', shieldCheck: 'shield-check', scroll: 'scroll',
            ghost: 'ghost', wand: 'wand-2', book: 'book', 
            footprints: 'footprints', hardHat: 'hard-hat', shirt: 'shirt',
            refreshCcw: 'refresh-ccw', coins: 'coins', star: 'star',
            biceps: 'biceps-flexed', bomb: 'bomb', gradCap: 'graduation-cap',
            logIn: 'log-in', userPlus: 'user-plus', arrowLeft: 'arrow-left',
            shoppingBag: 'shopping-bag', loader2: 'loader-2', award: 'award',
            flag: 'flag'
        };

        // --- ì „ì—­ ìƒíƒœ ë³€ìˆ˜ë“¤ ---
        window.state = {
            gameState: 'LOGIN',
            difficulty: 'EASY',
            floor: 1,
            logs: [],
            totalGold: 0,
            shopStats: { atk: 0, def: 0, hp: 0, epic: 0, legendary: 0, mythic: 0 },
            rerollsLeft: 0,
            user: { id: '', pw: '', confirm: '' },
            isLoading: false
        };

        window.player = {
            maxHp: 100, hp: 100, atk: 10, def: 2,
            critChance: 0.05, lifesteal: 0, potions: 3,
            class: null,
            abilities: { doubleShot: false, shieldBearer: false, resurrection: false, usedResurrection: false, barrier: false, berserker: false, soulReaper: false, bulkUp: false, learningBlade: false, glassCannon: false, investmentExpert: false },
            damageMultiplier: 1.0,
            weapon: null, weaponRarity: 'COMMON',
            armor: null, armorRarity: 'COMMON',
            pants: null, pantsRarity: 'COMMON',
            helmet: null, helmetRarity: 'COMMON',
            shoes: null, shoesRarity: 'COMMON',
            shoulder: null, shoulderRarity: 'COMMON',
            subWeapon: null, subWeaponRarity: 'COMMON',
            modifiers: { 'ëŒ€ì¥ì¥ì´': 0, 'ë‹¬ì¸': 0, 'ê³ ëŒ€': 0 },
            skills: []
        };

        window.enemy = { name: 'ìŠ¬ë¼ì„', maxHp: 20, hp: 20, atk: 5, def: 0, img: 'ğŸŸ¢', isGhost: false };
        window.battleState = { barrierTurns: 0, turnCount: 1, cooldowns: {}, skillUsage: {} };
        window.augments = [];
        window.showSkillModal = false;
        window.MAX_FLOOR = 100;

        // --- ë°ì´í„° DB (ì „ì—­) ---
        window.JOB_SKILLS = {
            'ê²€ì‚¬': [
                { id: 'w1', name: 'ê°•íƒ€', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 150% í”¼í•´ (ì¿¨: 2í„´)', cooldown: 2, damageMult: 1.5, icon: 'sword' },
                { id: 'w2', name: 'í”¼ì§€ì»¬ íŠ¸ë ˆì´ë‹', type: 'PASSIVE', desc: 'ì˜¬ìŠ¤íƒ¯ 20% ì¦ê°€', icon: 'trendingUp', onAcquire: (p) => { p.maxHp=Math.floor(p.maxHp*1.2); p.hp=Math.floor(p.hp*1.2); p.def=Math.floor(p.def*1.2); p.atk=Math.floor(p.atk*1.2); return p; } },
                { id: 'w3', name: 'ìµœê³ ì˜ ë°©ì–´', type: 'ACTIVE', desc: '1í„´ê°„ ë¬´ì  (ì¿¨: 6í„´)', cooldown: 6, effect: 'INVINCIBLE', duration: 1, icon: 'shieldCheck' },
                { id: 'w4', name: 'ìµœí›„ì˜ ì¼ê²©', type: 'PASSIVE', desc: 'HP 30% ì´í•˜ ì‹œ ê³µ 2ë°°', icon: 'skull' },
                { id: 'w5', name: 'ì•„í…Œë‚˜ì˜ ê²€', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 500% í”¼í•´ (1íšŒ)', cooldown: 999, damageMult: 5.0, oncePerBattle: true, icon: 'star' }
            ],
            'ë§ˆë²•ì‚¬': [
                { id: 'm1', name: 'ì—ë„ˆì§€ë³¼íŠ¸', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 150% í”¼í•´ (ì¿¨: 2í„´)', cooldown: 2, damageMult: 1.5, icon: 'sparkles' },
                { id: 'm2', name: 'ë§ˆë ¥ ê°•í™”', type: 'PASSIVE', desc: 'ê³µê²©ë ¥ 30% ì¦ê°€', icon: 'wand', onAcquire: (p) => { p.atk=Math.floor(p.atk*1.3); return p; } },
                { id: 'm3', name: 'íŒŒì´ì–´ë³¼', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 200% í”¼í•´ (ì¿¨: 2í„´)', cooldown: 2, damageMult: 2.0, icon: 'flame' },
                { id: 'm4', name: 'ì˜¤ë“œ ë°°ë¦¬ì–´', type: 'PASSIVE', desc: '4í„´ë§ˆë‹¤ 1í„´ ë¬´ì ', icon: 'shield' },
                { id: 'm5', name: 'ì œìš°ìŠ¤ì˜ ì²œë‘¥', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 500% í”¼í•´ (1íšŒ)', cooldown: 999, damageMult: 5.0, oncePerBattle: true, icon: 'zap' }
            ],
            'ê¶ìˆ˜': [
                { id: 'a1', name: 'ì†ì‚¬', type: 'PASSIVE', desc: '2íšŒ ê³µê²© (ë€ê° 40%)', icon: 'repeat' },
                { id: 'a2', name: 'ì§‘ì¤‘ë ¥ ê°•í™”', type: 'PASSIVE', desc: 'ì¹˜ëª…íƒ€ +30%', icon: 'target', onAcquire: (p) => { p.critChance+=0.3; return p; } },
                { id: 'a3', name: 'ê³µê²©ì  ë°©ì–´', type: 'PASSIVE', desc: 'ê³µê²©ë ¥ 30% ì¦ê°€', icon: 'sword', onAcquire: (p) => { p.atk=Math.floor(p.atk*1.3); return p; } },
                { id: 'a4', name: 'ìµœê³ ì˜ ì»¨ë””ì…˜', type: 'PASSIVE', desc: 'HP 70% ì´ìƒ ê³µ 1.5ë°°', icon: 'heart' },
                { id: 'a5', name: 'ì•„ë¥´í…Œë¯¸ìŠ¤ í™œ', type: 'ACTIVE', desc: 'ê³µê²©ë ¥ 500% í”¼í•´ (1íšŒ)', cooldown: 999, damageMult: 5.0, oncePerBattle: true, icon: 'star' }
            ]
        };

        window.WEAPON_DB = {
            'WARRIOR': [
                { tier: 'COMMON', name: 'ê²€', atk: 15 }, { tier: 'RARE', name: 'ë‚ ì¹´ë¡œìš´ ê²€', atk: 30 },
                { tier: 'EPIC', name: 'ì˜ì›…ì˜ ê²€', atk: 45 }, { tier: 'LEGENDARY', name: 'ì´ìˆœì‹ ì˜ ê²€', atk: 60 }, { tier: 'MYTHIC', name: 'ì•„í…Œë‚˜ì˜ ê²€', atk: 100 }
            ],
            'MAGE': [
                { tier: 'COMMON', name: 'ì§€íŒ¡ì´', atk: 15 }, { tier: 'RARE', name: 'ë§ˆë ¥ì˜ ì§€íŒ¡ì´', atk: 30 },
                { tier: 'EPIC', name: 'ì˜ì›…ì˜ ì§€íŒ¡ì´', atk: 45 }, { tier: 'LEGENDARY', name: 'ê°„ë‹¬í”„ì˜ ì§€íŒ¡ì´', atk: 60 }, { tier: 'MYTHIC', name: 'ì œìš°ìŠ¤ì˜ ì§€íŒ¡ì´', atk: 100 }
            ],
            'ARCHER': [
                { tier: 'COMMON', name: 'í™œ', atk: 15 }, { tier: 'RARE', name: 'ë¹›ë‚˜ëŠ” í™œ', atk: 30 },
                { tier: 'EPIC', name: 'ì˜ì›…ì˜ í™œ', atk: 45 }, { tier: 'LEGENDARY', name: 'ì£¼ëª½ì˜ í™œ', atk: 60 }, { tier: 'MYTHIC', name: 'ì•„ë¥´í…Œë¯¸ìŠ¤ì˜ í™œ', atk: 100 }
            ]
        };

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥/ë¡œë“œ ì‹œìŠ¤í…œ (ì„œë²„ ëŒ€ì²´) ---
        function saveUserData(userId, data) {
            const allUsers = JSON.parse(localStorage.getItem('tower_users') || '{}');
            allUsers[userId] = data;
            localStorage.setItem('tower_users', JSON.stringify(allUsers));
        }

        function loadUserData(userId) {
            const allUsers = JSON.parse(localStorage.getItem('tower_users') || '{}');
            return allUsers[userId];
        }

        // --- ìœ í‹¸ë¦¬í‹° ë° ë Œë”ë§ í—¬í¼ ---
        function getIconHtml(name) {
            return `<i data-lucide="${window.ICONS[name] || 'circle'}" size="14"></i>`;
        }

        function getHpBarColor(current, max) {
            const ratio = current / max;
            if (ratio > 0.5) return 'bg-green-500';
            if (ratio > 0.2) return 'bg-yellow-500';
            return 'bg-red-500';
        }

        function getPlayerIcon() {
            if (!window.player.class) return 'ğŸ§’';
            if (window.player.class === 'ê²€ì‚¬') return 'ğŸ›¡ï¸';
            if (window.player.class === 'ë§ˆë²•ì‚¬') return 'ğŸ§™â€â™€ï¸';
            if (window.player.class === 'ê¶ìˆ˜') return 'ğŸ§';
            return 'ğŸ‘¤';
        }

        function getRarityColorClass(tier) {
            switch(tier) {
                case 'MYTHIC': return 'text-mythic font-black'; 
                case 'LEGENDARY': return 'text-legendary font-bold'; 
                case 'EPIC': return 'text-epic font-bold';
                case 'RARE': return 'text-rare font-bold';
                default: return 'text-common';
            }
        }
        
        function getRarityBg(tier) {
             switch(tier) {
                case 'MYTHIC': return 'bg-red-50 border-red-200'; 
                case 'LEGENDARY': return 'bg-orange-50 border-orange-200'; 
                case 'EPIC': return 'bg-purple-50 border-purple-200';
                case 'RARE': return 'bg-blue-50 border-blue-200';
                default: return 'bg-gray-50 border-gray-200';
            }
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

        function addLog(text, type = 'normal') {
            window.state.logs.push({ text, type, id: Date.now() + Math.random() });
            window.render();
        }

        function setState(newState) {
            window.state.gameState = newState;
            window.render();
        }

        function updateInput(field, val) {
            window.state.user[field] = val;
        }

        function getRarity() {
            const roll = Math.random();
            const bonus = window.state.shopStats.mythic * 0.01;
            if (roll < 0.03 + bonus) return 'MYTHIC';
            if (roll < 0.10 + bonus) return 'LEGENDARY';
            if (roll < 0.30 + bonus) return 'EPIC';
            if (roll < 0.60) return 'RARE'; 
            return 'COMMON';
        }

        function getRarityInfo(tier) {
            switch(tier) {
                case 'MYTHIC': return { name: 'ì‹ í™”', multiplier: 3.0 };
                case 'LEGENDARY': return { name: 'ì „ì„¤', multiplier: 2.0 };
                case 'EPIC': return { name: 'ì˜ì›…', multiplier: 1.5 };
                case 'RARE': return { name: 'í¬ê·€', multiplier: 1.2 };
                default: return { name: 'ì¼ë°˜', multiplier: 1.0 };
            }
        }

        function getFloorReward(f) {
            const job = window.player.class || 'WARRIOR';
            const jobKey = (job === 'ê²€ì‚¬') ? 'WARRIOR' : (job === 'ë§ˆë²•ì‚¬') ? 'MAGE' : (job === 'ê¶ìˆ˜') ? 'ARCHER' : 'WARRIOR';

            const createArmor = (type, name, baseDef, icon) => {
                const tier = getRarity();
                const info = getRarityInfo(tier);
                
                let mod = 'ëŒ€ì¥ì¥ì´';
                const r = Math.random();
                if(r < 0.33) mod = 'ëŒ€ì¥ì¥ì´'; else if(r < 0.66) mod = 'ë‹¬ì¸'; else mod = 'ê³ ëŒ€';
                
                const def = Math.floor(baseDef * info.multiplier);
                return {
                    name: `[${info.name}] ${mod}ì˜ ${name}`,
                    desc: `ë°©ì–´ +${def} (ì„¸íŠ¸: ${mod})`,
                    icon: icon,
                    rarity: tier,
                    type: 'ARMOR',
                    action: () => {
                        window.player.def += def;
                        if(type === 'ARMOR') { window.player.armor = `${mod}ì˜ ${name}`; window.player.armorRarity = tier; }
                        if(type === 'PANTS') { window.player.pants = `${mod}ì˜ ${name}`; window.player.pantsRarity = tier; }
                        if(type === 'SHOULDER') { window.player.shoulder = `${mod}ì˜ ${name}`; window.player.shoulderRarity = tier; }
                        if(type === 'HELMET') { window.player.helmet = `${mod}ì˜ ${name}`; window.player.helmetRarity = tier; }
                        if(type === 'SHOES') { window.player.shoes = `${mod}ì˜ ${name}`; window.player.shoesRarity = tier; }
                        
                        window.player.modifiers[mod]++;
                        let bonus = '';
                        if(mod==='ëŒ€ì¥ì¥ì´') { 
                            if(window.player.modifiers[mod]===2) { window.player.def+=30; bonus='(2ì„¸íŠ¸)'; }
                            else if(window.player.modifiers[mod]>2) { window.player.def+=10; bonus='(+10)'; }
                        }
                        if(mod==='ë‹¬ì¸') {
                            if(window.player.modifiers[mod]===2) { window.player.atk+=30; bonus='(2ì„¸íŠ¸)'; }
                            else if(window.player.modifiers[mod]>2) { window.player.atk+=10; bonus='(+10)'; }
                        }
                        if(mod==='ê³ ëŒ€') {
                            if(window.player.modifiers[mod]>=2) { window.player.atk+=20; window.player.def+=20; window.player.hp+=20; bonus='(ê³ ëŒ€ì…‹)'; }
                        }
                        if(bonus) addLog(`âœ¨ ${mod} ì„¸íŠ¸ íš¨ê³¼!`, 'win');
                    }
                };
            };

            if (f === 10) {
                const pool = window.WEAPON_DB[jobKey];
                return [1,2,3].map(() => {
                    const tier = getRarity();
                    const info = getRarityInfo(tier);
                    const weapon = pool.find(w => w.tier === tier) || pool[0];
                    return { 
                        name: `[${info.name}] ${weapon.name}`, 
                        desc: `ê³µê²©ë ¥ +${weapon.atk}`, 
                        icon: 'sword', 
                        rarity: tier,
                        type: 'WEAPON',
                        action: () => { window.player.atk += weapon.atk; window.player.weapon = weapon.name; window.player.weaponRarity = tier; } 
                    }; 
                });
            }
            if (f === 20) return [1,2,3].map(() => createArmor('ARMOR', 'ê°‘ì˜·', 5, 'shirt'));
            if (f === 30) return [1,2,3].map(() => createArmor('PANTS', 'ê°‘ì˜· ë°”ì§€', 5, 'shieldCheck'));
            if (f === 40) return [1,2,3].map(() => createArmor('SHOULDER', 'ê²¬ê°‘', 5, 'shield'));
            
            if (f === 50) {
                let subName = 'ë³´ì¡°ë¬´ê¸°';
                let icon = 'star';
                if (job === 'ê²€ì‚¬') { subName = 'ê¸°ì‚¬ì˜ ë°©íŒ¨'; icon = 'shieldCheck'; }
                if (job === 'ë§ˆë²•ì‚¬') { subName = 'ê³ ëŒ€ ë§ˆë²•ì„œ'; icon = 'book'; }
                if (job === 'ê¶ìˆ˜') { subName = 'ê°•ì²  í™”ì‚´'; icon = 'target'; }

                return [1,2,3].map(() => ({ 
                    name: subName, 
                    desc: 'ê³µê²©ë ¥ +30, ì¹˜ëª…íƒ€ +10%', 
                    icon: icon, 
                    rarity: 'EPIC', 
                    type: 'SUB_WEAPON', 
                    action: () => { 
                        window.player.atk += 30; 
                        window.player.critChance += 0.10; 
                        window.player.subWeapon = subName; 
                        window.player.subWeaponRarity = 'EPIC'; 
                    } 
                })); 
            }
            
            if (f === 60) return [1,2,3].map(() => createArmor('HELMET', 'íˆ¬êµ¬', 8, 'hardHat'));
            if (f === 70) return [1,2,3].map(() => createArmor('SHOES', 'ì‹ ë°œ', 5, 'footprints'));
            if (f >= 80 && f < 100) return [1,2,3].map(() => ({ name: 'ìŠ¤íƒ¯ ë¶€ìŠ¤íŠ¸', desc: 'ê³µê²©ë ¥ +50', icon: 'sword', rarity: 'COMMON', type: 'STAT', action: () => { window.player.atk += 50; } }));
            
            return null;
        }

        function generateAugments() {
            window.augments = [];
            const fixed = getFloorReward(window.state.floor);
            if (fixed) { window.augments = fixed; return; }
            
             const statPool = [
                 { name: 'ê·¼ë ¥ ê°•í™”', desc: 'ATK +3', icon: 'sword', type: 'STAT', action: () => window.player.atk += 3 },
                 { name: 'í”¼ë¶€ ê²½í™”', desc: 'DEF +1', icon: 'shield', type: 'STAT', action: () => window.player.def += 1 },
                 { name: 'ì²´ë ¥ ì¦ê°€', desc: 'MaxHP +20', icon: 'heart', type: 'STAT', action: () => { window.player.maxHp+=20; window.player.hp+=20; } },
                 { name: 'ì™„ì „ íœ´ì‹', desc: 'HP 100% íšŒë³µ', icon: 'refreshCw', type: 'STAT', action: () => window.player.hp = window.player.maxHp },
                 { name: 'ì•½ì  í¬ì°©', desc: 'ì¹˜ëª…íƒ€ +5%', icon: 'zap', type: 'STAT', action: () => window.player.critChance += 0.05 },
                 { name: 'ë³´ê¸‰í’ˆ', desc: 'í¬ì…˜ +1', icon: 'trendingUp', type: 'STAT', action: () => window.player.potions += 1 },
                 { name: 'í¡í˜ˆ ë³¸ëŠ¥', desc: 'í¡í˜ˆ +5%', icon: 'skull', type: 'STAT', action: () => window.player.lifesteal += 0.05 },
            ];

            const abilityPool = [
                 { name: 'ì—°ì† ì‚¬ê²©', desc: '2íšŒ ê³µê²© (ë€ê° 35%)', icon: 'repeat', type: 'ABILITY', cond: !window.player.abilities.doubleShot, action: () => window.player.abilities.doubleShot = true },
                 { name: 'ë°°ë¦¬ì–´', desc: 'ì „íˆ¬ ì‹œì‘ 1í„´ ë¬´ì ', icon: 'shieldCheck', type: 'ABILITY', cond: !window.player.abilities.barrier, action: () => window.player.abilities.barrier = true },
                 { name: 'ì˜í˜¼ ìˆ˜í™•ì', desc: 'ì²˜ì¹˜ì‹œ HP+5', icon: 'ghost', type: 'ABILITY', cond: !window.player.abilities.soulReaper, action: () => window.player.abilities.soulReaper = true },
                 { name: 'ìœ ë¦¬ ëŒ€í¬', desc: 'í”¼í•´ëŸ‰ +50%, í”¼ê²© +30%', icon: 'bomb', type: 'ABILITY', cond: !window.player.abilities.glassCannon, action: () => window.player.abilities.glassCannon = true },
                 { name: 'íˆ¬ì ì „ë¬¸ê°€', desc: 'í´ë¦¬ì–´ì‹œ +3ê³¨ë“œ', icon: 'coins', type: 'ABILITY', cond: !window.player.abilities.investmentExpert, action: () => window.player.abilities.investmentExpert = true },
                 { name: 'ë²Œí¬ì—…', desc: 'ì²˜ì¹˜ì‹œ ATK+3', icon: 'biceps', type: 'ABILITY', cond: !window.player.abilities.bulkUp, action: () => window.player.abilities.bulkUp = true },
                 { name: 'í•™ìŠµí•˜ëŠ” ì¹¼ë‚ ', desc: 'ë³´ìŠ¤ ì²˜ì¹˜ì‹œ ì˜¬ìŠ¤íƒ¯ UP', icon: 'gradCap', type: 'ABILITY', cond: !window.player.abilities.learningBlade, action: () => window.player.abilities.learningBlade = true }
            ];

            const availableStats = statPool.sort(() => 0.5 - Math.random()).slice(0, 2);
            const availableAbilities = abilityPool.filter(i => i.cond === undefined || i.cond === true).sort(() => 0.5 - Math.random()).slice(0, 1);
            
            window.augments = [...availableStats, ...availableAbilities].sort(() => 0.5 - Math.random());
            if(window.augments.length < 3) {
                window.augments = [...statPool].sort(() => 0.5 - Math.random()).slice(0, 3);
            }
        }

        // --- ë Œë”ë§ ì»´í¬ë„ŒíŠ¸ ---
        function renderLogin() {
            return `
            <div class="w-full max-w-sm bg-white border-4 border-black p-6 rounded text-center shadow-[8px_8px_0_0_rgba(0,0,0,0.5)]">
                <h1 class="text-4xl font-bold mb-8 tracking-tighter">TOWER<br>BREAKER</h1>
                <input id="login-id" type="text" placeholder="ì•„ì´ë””" class="w-full p-3 mb-2 border-2 border-black text-lg font-bold bg-gray-100 focus:outline-none focus:bg-white" value="${state.user.id}" oninput="updateInput('id', this.value)">
                <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 mb-6 border-2 border-black text-lg font-bold bg-gray-100 focus:outline-none focus:bg-white" value="${state.user.pw}" oninput="updateInput('pw', this.value)">
                <button onclick="handleLogin()" class="w-full bg-black text-white py-3 border-2 border-black hover:bg-gray-800 font-bold text-xl mb-2 retro-btn">
                   ê²Œì„ ì‹œì‘
                </button>
                <button onclick="setState('SIGNUP')" class="w-full bg-white text-black py-3 border-2 border-black hover:bg-gray-100 font-bold text-xl retro-btn">íšŒì›ë“±ë¡</button>
                <p class="text-xs text-gray-500 mt-4">*ë°ì´í„°ëŠ” ì´ ì»´í“¨í„°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>`;
        }

        function renderSignup() {
            return `
            <div class="w-full max-w-sm bg-white border-4 border-black p-6 rounded text-center shadow-[8px_8px_0_0_rgba(0,0,0,0.5)]">
                <h2 class="text-2xl font-bold mb-6">ëª¨í—˜ê°€ ë“±ë¡</h2>
                <input id="signup-id" type="text" placeholder="ì•„ì´ë””" class="w-full p-3 mb-2 border-2 border-black bg-gray-100">
                <input id="signup-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 mb-2 border-2 border-black bg-gray-100">
                <input id="signup-confirm" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full p-3 mb-6 border-2 border-black rounded bg-gray-100">
                <button onclick="handleSignup()" class="w-full bg-black text-white py-3 border-2 border-black hover:bg-gray-800 font-bold mb-2 retro-btn">ë“±ë¡í•˜ê¸°</button>
                <button onclick="setState('LOGIN')" class="w-full bg-white text-black py-3 border-2 border-black hover:bg-gray-100 font-bold retro-btn">ëŒì•„ê°€ê¸°</button>
            </div>`;
        }

        function renderStart() {
            return `
            <div class="w-full max-w-sm bg-white border-4 border-black p-8 rounded text-center shadow-[8px_8px_0_0_rgba(0,0,0,0.5)]">
               <h1 class="text-5xl font-bold mb-4 tracking-tighter">TOWER<br>BREAKER</h1>
               <div class="text-xl mb-8 font-bold text-gray-600">100ì¸µì„ í–¥í•˜ì—¬</div>
               <button onclick="setState('DIFFICULTY_SELECT')" class="w-full bg-black text-white py-4 text-2xl font-bold border-2 border-black hover:bg-gray-800 retro-btn animate-pulse">
                 START
               </button>
               <div class="mt-4 text-sm text-gray-500 font-bold">ID: ${state.user.id}</div>
            </div>`;
        }

        function renderDifficultySelect() {
            return `
            <div class="w-full max-w-sm bg-white border-4 border-black p-6 rounded text-center shadow-[8px_8px_0_0_rgba(0,0,0,0.5)]">
               <h2 class="text-3xl font-bold mb-6">ë‚œì´ë„ ì„ íƒ</h2>
               <div class="space-y-4">
                  <button onclick="startNewGame('EASY')" class="w-full p-4 border-2 border-black bg-green-100 hover:bg-green-200 font-bold text-xl text-left flex justify-between items-center group retro-btn">
                      <span>ğŸŒ± ì‰¬ì›€</span> <span class="group-hover:-translate-x-2 transition-transform">â—€</span>
                  </button>
                  <button onclick="startNewGame('NORMAL')" class="w-full p-4 border-2 border-black bg-blue-100 hover:bg-blue-200 font-bold text-xl text-left flex justify-between items-center group retro-btn">
                      <span>âš”ï¸ ë³´í†µ</span> <span class="group-hover:-translate-x-2 transition-transform">â—€</span>
                  </button>
                  <button onclick="startNewGame('HARD')" class="w-full p-4 border-2 border-black bg-red-100 hover:bg-red-200 font-bold text-xl text-left flex justify-between items-center group retro-btn">
                      <span>ğŸ”¥ ì–´ë ¤ì›€</span> <span class="group-hover:-translate-x-2 transition-transform">â—€</span>
                  </button>
               </div>
               <button onclick="setState('SHOP')" class="mt-6 w-full p-3 border-2 border-black bg-yellow-100 hover:bg-yellow-200 font-bold text-lg retro-btn flex items-center justify-center gap-2">
                   ğŸ›ï¸ ìƒì  (${window.state.totalGold} G)
               </button>
            </div>`;
        }

        function renderShop() {
            return `
            <div class="w-full max-w-xl bg-white border-4 border-black p-6 rounded text-left shadow-2xl overflow-hidden relative">
                <div class="flex justify-between items-center border-b-4 border-black pb-4 mb-4">
                    <h2 class="text-3xl font-bold">ìƒì </h2>
                    <div class="bg-yellow-100 border-2 border-black px-3 py-1 font-bold">ğŸ’° ${window.state.totalGold} G</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                    <div class="space-y-2">
                        <div class="font-bold bg-black text-white p-1 text-center">ê¸°ë³¸ ëŠ¥ë ¥ì¹˜</div>
                        ${renderShopItem('atk', 'ê³µê²©ë ¥ ê°•í™”', 'ATK +1', 50)}
                        ${renderShopItem('def', 'ë°©ì–´ë ¥ ê°•í™”', 'DEF +1', 200)}
                        ${renderShopItem('hp', 'ì²´ë ¥ ê°•í™”', 'MaxHP +1', 50)}
                    </div>
                    <div class="space-y-2">
                        <div class="font-bold bg-black text-white p-1 text-center">í–‰ìš´ (ë“œëë¥ )</div>
                        ${renderShopItem('epic', 'ì˜ì›… í™•ë¥ ', '+1%', 200)}
                        ${renderShopItem('legendary', 'ì „ì„¤ í™•ë¥ ', '+1%', 500)}
                        ${renderShopItem('mythic', 'ì‹ í™” í™•ë¥ ', '+1%', 1500)}
                    </div>
                </div>
                <button onclick="setState('DIFFICULTY_SELECT')" class="mt-4 w-full py-3 bg-black text-white font-bold border-2 border-black hover:bg-gray-800 retro-btn">ë‚˜ê°€ê¸°</button>
            </div>`;
        }
        
        function renderShopItem(type, name, effect, cost) {
            return `
            <button onclick="buyItem('${type}', ${cost})" class="w-full flex justify-between items-center p-3 border-2 border-black hover:bg-gray-100 active:bg-gray-200 retro-btn">
                <div>
                    <div class="font-bold">${name}</div>
                    <div class="text-xs text-gray-500">${effect}</div>
                </div>
                <div class="text-right">
                    <div class="font-bold">${cost}G</div>
                    <div class="text-xs bg-gray-200 px-1 rounded">Lv.${window.state.shopStats[type]}</div>
                </div>
            </button>`;
        }

        function renderAugment() {
            let rerollBtn = '';
            if (window.state.rerollsLeft > 0 && window.state.floor % 10 === 0) {
                rerollBtn = `<button onclick="handleReroll()" class="mt-4 px-4 py-2 bg-blue-500 text-white font-bold border-2 border-black hover:bg-blue-600 retro-btn">ğŸ² ë¦¬ë¡¤ (${window.state.rerollsLeft}íšŒ)</button>`;
            }

            return `
            <div class="w-full max-w-md bg-white border-4 border-black p-6 rounded-lg text-center shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 bg-yellow-300 border-y-4 border-black py-2">
                    ${window.state.floor % 10 === 0 ? 'âœ¨ ë³´ìƒ íšë“!' : 'ğŸ ë ˆë²¨ ì—…!'}
                </h2>
                <div class="space-y-3">
                    ${window.augments.map((aug, idx) => {
                        const isAbility = aug.type === 'ABILITY';
                        const rarityColor = aug.rarity ? getRarityColorClass(aug.rarity) : 'text-gray-800';
                        const bgClass = aug.rarity ? getRarityBg(aug.rarity) : (isAbility ? 'bg-purple-50 border-purple-300' : 'bg-gray-50 border-gray-300');
                        const specialTag = isAbility ? '<span class="text-[10px] bg-purple-600 text-white px-1.5 py-0.5 rounded font-bold ml-2">ëŠ¥ë ¥</span>' : '';

                        return `
                        <button onclick="selectAugment(${idx})" class="w-full p-4 border-2 border-black ${bgClass} hover:brightness-95 text-left group relative retro-btn flex items-center gap-3">
                            <div class="p-2 bg-white border border-black rounded-full">${getIconHtml(aug.icon)}</div>
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <span class="font-bold text-lg ${rarityColor}">${aug.name}</span>
                                    ${specialTag}
                                </div>
                                <div class="text-sm text-gray-600 font-medium">${aug.desc}</div>
                            </div>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 font-bold text-black">â—€</div>
                        </button>`;
                    }).join('')}
                </div>
                ${rerollBtn}
            </div>`;
        }

        function renderClassSelect() {
            return `
            <div class="w-full max-w-md bg-white border-4 border-black p-6 rounded text-center shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">ìš´ëª…ì˜ ê°ˆë¦¼ê¸¸</h2>
                <div class="space-y-4">
                    <button onclick="handleClassSelect('WARRIOR')" class="w-full p-4 border-2 border-black bg-red-100 hover:bg-red-200 text-left retro-btn">
                        <div class="font-bold text-xl">ğŸ›¡ï¸ ê²€ì‚¬</div>
                        <div class="text-sm">ê· í˜• ì¡íŒ ëŠ¥ë ¥ì¹˜</div>
                    </button>
                    <button onclick="handleClassSelect('MAGE')" class="w-full p-4 border-2 border-black bg-blue-100 hover:bg-blue-200 text-left retro-btn">
                        <div class="font-bold text-xl">ğŸ§™â€â™€ï¸ ë§ˆë²•ì‚¬</div>
                        <div class="text-sm">ê°•ë ¥í•œ ê³µê²©ë ¥</div>
                    </button>
                    <button onclick="handleClassSelect('ARCHER')" class="w-full p-4 border-2 border-black bg-green-100 hover:bg-green-200 text-left retro-btn">
                        <div class="font-bold text-xl">ğŸ§ ê¶ìˆ˜</div>
                        <div class="text-sm">ë†’ì€ ì¹˜ëª…íƒ€ í™•ë¥ </div>
                    </button>
                </div>
            </div>`;
        }

        function renderEndGame() {
            const isVictory = window.state.gameState === 'VICTORY';
            return `
            <div class="w-full max-w-md bg-white border-4 border-black p-8 rounded text-center shadow-2xl">
                <div class="text-6xl mb-4">${isVictory ? 'ğŸ†' : 'ğŸ’€'}</div>
                <h2 class="text-4xl font-bold mb-4 ${isVictory ? 'text-yellow-600' : 'text-red-600'}">${isVictory ? 'ì •ë³µ ì™„ë£Œ!' : 'ì‚¬ë§...'}</h2>
                <div class="text-xl mb-8 border-b-2 border-black pb-4">ë„ë‹¬ ì¸µìˆ˜: <b>${window.state.floor}ì¸µ</b></div>
                <button onclick="setState('DIFFICULTY_SELECT')" class="w-full bg-black text-white py-4 text-xl font-bold border-2 border-black hover:bg-gray-800 retro-btn">
                    ë‹¤ì‹œ ë„ì „í•˜ê¸°
                </button>
            </div>`;
        }

        function renderSkillModal() {
            if (player.skills.length === 0) return '';
            
            const skillsHtml = player.skills.map(idx => {
                const skill = window.JOB_SKILLS[window.player.class][idx];
                const isPassive = skill.type === 'PASSIVE';
                const cooldown = window.battleState.cooldowns[idx] || 0;
                const used = skill.oncePerBattle && window.battleState.skillUsage[idx];
                const disabled = isPassive || cooldown > 0 || used;
                
                return `
                <button onclick="${!disabled ? `useSkill(${idx})` : ''}" class="w-full text-left p-3 border-2 border-black rounded hover:bg-gray-100 ${disabled ? 'opacity-50 cursor-not-allowed' : 'retro-btn'} relative mb-3 bg-white">
                    <div class="flex justify-between font-bold items-center mb-1">
                        <span class="flex items-center gap-2 text-lg">
                            <span class="p-1 bg-gray-200 rounded border border-black">${getIconHtml(skill.icon)}</span>
                            <span>${skill.name}</span>
                        </span>
                        <span class="text-xs text-white px-2 py-1 rounded border border-black ${isPassive ? 'bg-blue-600' : 'bg-red-600'}">${isPassive ? 'íŒ¨ì‹œë¸Œ' : 'ì•¡í‹°ë¸Œ'}</span>
                    </div>
                    <div class="text-sm text-gray-700 pl-8 mb-1">${skill.desc}</div>
                    ${!isPassive ? `<div class="text-xs text-gray-500 pl-8">ì¿¨íƒ€ì„: ${skill.cooldown}í„´</div>` : ''}
                    
                    ${!isPassive && cooldown > 0 ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center text-white font-bold rounded backdrop-blur-[1px] text-lg">â³ ${cooldown}í„´ í›„ ì‚¬ìš© ê°€ëŠ¥</div>` : ''}
                    ${!isPassive && used ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center text-gray-200 font-bold rounded backdrop-blur-[1px] text-lg">âœ… ì‚¬ìš© ì™„ë£Œ</div>` : ''}
                </button>`;
            }).join('');

            return `
            <div class="absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center p-4">
                <div class="paper-texture w-[90%] max-w-2xl h-auto max-h-[90%] rounded border-4 border-[#5d4037] p-6 shadow-2xl relative flex flex-col bg-[#e6d5ac]">
                    <div class="text-center font-bold text-2xl text-[#5d4037] mb-4 border-b-4 border-[#5d4037] pb-2">âš”ï¸ ê¸°ìˆ  ë°°ì¹˜ ğŸ›¡ï¸</div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                        <div class="grid grid-cols-1 gap-1">
                            ${skillsHtml}
                        </div>
                    </div>
                    <button onclick="closeSkillModal()" class="mt-4 w-full bg-[#5d4037] text-[#e6d5ac] py-3 rounded font-bold hover:bg-[#3e2723] text-xl border-2 border-black retro-btn">ë‹«ê¸°</button>
                </div>
            </div>`;
        }

        function renderGameOverlay() {
            if (window.state.gameState === 'AUGMENT') return renderAugment();
            if (window.state.gameState === 'CLASS_SELECT') return renderClassSelect();
            if (window.state.gameState === 'GAMEOVER' || window.state.gameState === 'VICTORY') return renderEndGame();
            if (window.showSkillModal) return renderSkillModal();
            return '';
        }

        function renderOverlay() {
            if (window.state.gameState === 'LOGIN') return renderLogin();
            if (window.state.gameState === 'SIGNUP') return renderSignup();
            if (window.state.gameState === 'START') return renderStart();
            if (window.state.gameState === 'DIFFICULTY_SELECT') return renderDifficultySelect();
            if (window.state.gameState === 'SHOP') return renderShop();
            if (window.state.gameState === 'AUGMENT') return renderAugment();
            if (window.state.gameState === 'CLASS_SELECT') return renderClassSelect();
            if (window.state.gameState === 'GAMEOVER' || window.state.gameState === 'VICTORY') return renderEndGame();
            return '';
        }

        function getSetEffectText() {
            let texts = [];
            const mods = window.player.modifiers;
            if (mods['ëŒ€ì¥ì¥ì´'] >= 2) texts.push(`ëŒ€ì¥ì¥ì´ ${mods['ëŒ€ì¥ì¥ì´']}ì…‹ (ë°©ì–´+${mods['ëŒ€ì¥ì¥ì´']===2?30:30+(mods['ëŒ€ì¥ì¥ì´']-2)*10})`);
            if (mods['ë‹¬ì¸'] >= 2) texts.push(`ë‹¬ì¸ ${mods['ë‹¬ì¸']}ì…‹ (ê³µê²©+${mods['ë‹¬ì¸']===2?30:30+(mods['ë‹¬ì¸']-2)*10})`);
            if (mods['ê³ ëŒ€'] >= 2) texts.push(`ê³ ëŒ€ ${mods['ê³ ëŒ€']}ì…‹ (ì˜¬ìŠ¤íƒ¯+${mods['ê³ ëŒ€']===2?20:20+(mods['ê³ ëŒ€']-2)*20})`);
            return texts.length > 0 ? texts.join(' / ') : '';
        }
        
        function renderActiveAbilities() {
            const abils = window.player.abilities;
            const icons = [];
            
            if(abils.doubleShot) icons.push({icon:'repeat', color:'text-yellow-600', title:'ì—°ì† ì‚¬ê²©'});
            if(abils.shieldBearer) icons.push({icon:'shieldCheck', color:'text-blue-600', title:'ë°©íŒ¨ë³‘'});
            if(abils.barrier) icons.push({icon:'shieldCheck', color:'text-cyan-500', title:'ë°°ë¦¬ì–´'});
            if(abils.soulReaper) icons.push({icon:'ghost', color:'text-purple-600', title:'ì˜í˜¼ ìˆ˜í™•ì'});
            if(abils.bulkUp) icons.push({icon:'biceps', color:'text-orange-600', title:'ë²Œí¬ì—…'});
            if(abils.glassCannon) icons.push({icon:'bomb', color:'text-red-600', title:'ìœ ë¦¬ ëŒ€í¬'});
            if(abils.learningBlade) icons.push({icon:'gradCap', color:'text-indigo-600', title:'í•™ìŠµí•˜ëŠ” ì¹¼ë‚ '});
            if(abils.investmentExpert) icons.push({icon:'coins', color:'text-yellow-500', title:'íˆ¬ì ì „ë¬¸ê°€'});
            if(abils.resurrection && !abils.usedResurrection) icons.push({icon:'heart', color:'text-pink-500', title:'ë¶€í™œ ëŒ€ê¸°'});
            
            return icons.map(i => `<div class="${i.color} bg-gray-100 p-0.5 rounded border border-gray-300" title="${i.title}">${getIconHtml(i.icon)}</div>`).join('');
        }

        // --- Main Render Function (Global) ---
        window.render = function() {
            const app = document.getElementById('app');
            if (!app) return;
            
            if (['LOGIN', 'SIGNUP', 'START', 'DIFFICULTY_SELECT', 'SHOP'].includes(window.state.gameState)) {
                app.innerHTML = renderOverlay();
                window.lucide.createIcons();
                return;
            }

            let html = `
            <div class="relative w-full max-w-5xl aspect-video bg-[#f0f0f0] flex flex-col retro-border overflow-hidden">
                
                <div class="flex-1 bg-white border-b-4 border-black relative overflow-hidden dungeon-bg">
                    
                    <div class="absolute top-2 left-2 right-2 flex justify-between text-white text-xs z-30 pointer-events-none">
                        <div class="bg-black/50 px-2 py-1 rounded pointer-events-auto">Floor ${window.state.floor} (${window.state.difficulty})</div>
                        <div class="flex gap-2 pointer-events-auto">
                             <div class="bg-black/50 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="coins" size="12"></i> ${window.state.totalGold}</div>
                             ${window.state.gameState === 'BATTLE' ? `<button onclick="window.giveUp()" class="bg-red-600/80 hover:bg-red-700 text-white px-2 py-1 rounded flex items-center gap-1 transition cursor-pointer z-50 pointer-events-auto"><i data-lucide="flag" size="12"></i> í¬ê¸°</button>` : ''}
                        </div>
                    </div>

                    <div class="absolute top-4 left-4 z-20 bg-white border-2 border-black rounded p-2 shadow-[2px_2px_0_0_rgba(0,0,0,0.5)] min-w-[140px]">
                        <div class="flex justify-between items-center text-sm font-bold mb-1">
                            <span>${window.enemy.name}</span>
                            <span class="text-xs">Lv.${window.state.floor}</span>
                        </div>
                        <div class="w-full h-3 bg-gray-300 rounded border border-black relative overflow-hidden">
                             <div class="h-full ${getHpBarColor(window.enemy.hp, window.enemy.maxHp)} hp-fill" style="width: ${(window.enemy.hp/window.enemy.maxHp)*100}%"></div>
                        </div>
                    </div>

                    <div class="absolute top-16 right-8 z-10 animate-float">
                        <div class="text-7xl filter drop-shadow-lg scale-x-[-1] transition-transform duration-300 transform hover:scale-110 cursor-crosshair">
                            ${window.enemy.img}
                        </div>
                        ${window.enemy.isGhost ? '<div class="absolute -top-4 -right-4 text-2xl">ğŸ‘»</div>' : ''}
                    </div>

                    <div class="absolute bottom-4 left-10 z-10">
                         <div class="text-8xl filter drop-shadow-xl">${getPlayerIcon()}</div>
                         ${window.battleState.barrierTurns > 0 ? '<div class="absolute -top-10 left-1/2 -translate-x-1/2 text-3xl animate-pulse">ğŸ›¡ï¸</div>' : ''}
                    </div>

                    <div class="absolute bottom-8 right-4 z-20 bg-white border-2 border-black rounded p-2 shadow-[2px_2px_0_0_rgba(0,0,0,0.5)] w-[340px]">
                        <div class="flex justify-between items-center text-sm font-bold mb-1">
                            <span>${window.player.class || 'ì´ˆë³´ì'}</span>
                            <span class="text-xs">Lv.${window.state.floor}</span>
                        </div>
                        
                        <div class="flex items-center gap-1 text-xs font-bold bg-yellow-100 px-1 rounded border border-black mb-1">
                            <span>HP</span>
                            <div class="flex-1 h-3 bg-gray-300 rounded border border-black relative overflow-hidden">
                                <div class="h-full ${getHpBarColor(window.player.hp, window.player.maxHp)} hp-fill" style="width: ${(window.player.hp/window.player.maxHp)*100}%"></div>
                            </div>
                            <span>${window.player.hp}/${window.player.maxHp}</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-1 text-[10px] mb-2">
                           <div class="flex items-center gap-1 bg-gray-100 px-1 rounded"><i data-lucide="sword" size="10"></i> ${window.player.atk}</div>
                           <div class="flex items-center gap-1 bg-gray-100 px-1 rounded"><i data-lucide="shield" size="10"></i> ${window.player.def}</div>
                           <div class="flex items-center gap-1 bg-gray-100 px-1 rounded"><i data-lucide="zap" size="10"></i> ${Math.floor(window.player.critChance*100)}%</div>
                        </div>

                        <div class="border-t border-black pt-1 text-[9px] grid grid-cols-2 gap-x-2 gap-y-0.5 mb-1">
                            <span class="${getRarityColorClass(window.player.weaponRarity)} truncate">âš”ï¸ ${window.player.weapon || '-'}</span>
                            <span class="${getRarityColorClass(window.player.armorRarity)} truncate">ğŸ‘• ${window.player.armor || '-'}</span>
                            <span class="${getRarityColorClass(window.player.pantsRarity)} truncate">ğŸ‘– ${window.player.pants || '-'}</span>
                            <span class="${getRarityColorClass(window.player.subWeaponRarity)} truncate">ğŸ›¡ï¸ ${window.player.subWeapon || '-'}</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-1 border-t border-black pt-1">
                             ${renderActiveAbilities()}
                        </div>
                        <div class="text-[9px] text-blue-600 font-bold mt-0.5 truncate">
                            ${getSetEffectText()}
                        </div>
                    </div>
                </div>

                <div class="h-[35%] bg-[#202020] p-3 flex gap-3 border-t-4 border-black">
                    
                    <div class="flex-1 bg-white border-4 border-[#505050] rounded p-2 relative" style="box-shadow: inset 4px 4px 0px 0px #ced4da;">
                        <div id="log-container" class="h-full overflow-y-auto font-bold text-sm leading-relaxed custom-scrollbar p-1">
                            ${window.state.logs.length === 0 ? '<div class="text-gray-500 mt-2 text-center">ì•¼ìƒì˜ ëª¬ìŠ¤í„°ê°€ ë‚˜íƒ€ë‚¬ë‹¤!</div>' : ''}
                            ${[...window.state.logs].reverse().map((log, i) => 
                                `<div class="mb-1 ${i===0 ? 'text-black' : 'text-gray-500'}">
                                    ${i===0 ? 'â–¶ ' : ''}${log.text}
                                 </div>`
                            ).join('')}
                        </div>
                    </div>

                    <div class="w-44 bg-white border-4 border-[#505050] rounded p-1" style="box-shadow: inset 4px 4px 0px 0px #ced4da;">
                         <div class="grid grid-cols-2 grid-rows-2 gap-1 h-full">
                            <button onclick="playerTurn('ATTACK')" ${window.state.gameState !== 'BATTLE' ? 'disabled' : ''} class="retro-btn bg-[#f8f9fa] hover:bg-[#e9ecef] border-2 border-[#adb5bd] rounded flex items-center justify-center text-lg font-bold group">
                                <span class="group-hover:translate-x-1 transition-transform">ê³µê²©</span>
                            </button>
                            <button onclick="openSkillModal()" ${window.state.gameState !== 'BATTLE' || !window.player.class ? 'disabled' : ''} class="retro-btn bg-[#f8f9fa] hover:bg-[#e9ecef] border-2 border-[#adb5bd] rounded flex items-center justify-center text-lg font-bold group">
                                <span class="group-hover:translate-x-1 transition-transform">ìŠ¤í‚¬</span>
                            </button>
                            <button onclick="playerTurn('DEFEND')" ${window.state.gameState !== 'BATTLE' ? 'disabled' : ''} class="retro-btn bg-[#f8f9fa] hover:bg-[#e9ecef] border-2 border-[#adb5bd] rounded flex items-center justify-center text-lg font-bold group">
                                <span class="group-hover:translate-x-1 transition-transform">ë°©ì–´</span>
                            </button>
                            <button onclick="playerTurn('POTION')" ${window.state.gameState !== 'BATTLE' || window.player.potions <= 0 ? 'disabled' : ''} class="retro-btn bg-[#f8f9fa] hover:bg-[#e9ecef] border-2 border-[#adb5bd] rounded flex flex-col items-center justify-center transition-colors relative group">
                                <span class="text-lg font-bold group-hover:translate-x-1 transition-transform">íšŒë³µ</span>
                                <span class="absolute bottom-0 right-1 text-[10px] bg-black text-white px-1 rounded">${window.player.potions}</span>
                            </button>
                         </div>
                    </div>
                </div>

                ${['AUGMENT', 'CLASS_SELECT', 'GAMEOVER', 'VICTORY'].includes(window.state.gameState) || window.showSkillModal ? 
                  `<div class="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                      ${renderGameOverlay()}
                   </div>` : ''
                }
            </div>
            `;

            app.innerHTML = html;
            window.lucide.createIcons();
            
            const logContainer = document.getElementById('log-container');
            if (logContainer && !window.showSkillModal) logContainer.scrollTop = 0;
        };
        
        window.giveUp = function() {
            if (confirm("ì •ë§ í¬ê¸°í•˜ê³  ë§ˆì„ë¡œ ëŒì•„ê°ˆê¹Œ?")) {
                window.setState('DIFFICULTY_SELECT');
                window.addLog("ë„ì „ì„ í¬ê¸°í•˜ê³  ê·€í™˜í–ˆìŠµë‹ˆë‹¤.", 'system');
                // ì €ì¥
                if(window.state.user.id) {
                     const data = loadUserData(window.state.user.id) || {};
                     data.totalGold = window.state.totalGold;
                     saveUserData(window.state.user.id, data);
                }
            }
        };

        // --- Action Handlers (Modified for LocalStorage) ---
        
        window.handleLogin = async () => {
            const idInput = document.getElementById('login-id').value;
            const pwInput = document.getElementById('login-pw').value;
            if (!idInput || !pwInput) return alert('ì•„ì´ë””ì™€ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const data = loadUserData(idInput);
            
            if (data && data.password === pwInput) {
                window.state.user.id = idInput;
                window.state.totalGold = data.totalGold || 0;
                window.state.shopStats = data.shopStats || { atk: 0, def: 0, hp: 0, epic: 0, legendary: 0, mythic: 0 };
                
                window.setState('START');
                window.addLog(`í™˜ì˜í•©ë‹ˆë‹¤, ${idInput}ë‹˜!`, 'system');
            } else {
                alert('ì•„ì´ë””ê°€ ì—†ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            }
        };

        window.handleSignup = async () => {
             const id = document.getElementById('signup-id').value;
             const pw = document.getElementById('signup-pw').value;
             const cf = document.getElementById('signup-confirm').value;
             if(!id || !pw) return alert('ì…ë ¥í•´ì£¼ì„¸ìš”');
             if(pw !== cf) return alert('ë¹„ë²ˆ ë¶ˆì¼ì¹˜');
             
             const data = loadUserData(id);
             if(data) {
                 alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
             } else {
                 saveUserData(id, { password: pw, totalGold: 0, shopStats: { atk:0, def:0, hp:0, epic:0, legendary:0, mythic:0 } });
                 alert('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                 window.setState('LOGIN');
             }
        };

        // ê²Œì„ ì €ì¥ ë¡œì§ ì¶”ê°€ (ì•„ì´í…œ êµ¬ë§¤ ì‹œ ë“±)
        function saveGame() {
            if(window.state.user.id) {
                const data = loadUserData(window.state.user.id) || {};
                data.totalGold = window.state.totalGold;
                data.shopStats = window.state.shopStats;
                saveUserData(window.state.user.id, data);
            }
        }

        window.startNewGame = (diff) => {
            window.state.difficulty = diff;
            window.state.floor = 1;
            window.player = {
                maxHp: 100 + window.state.shopStats.hp, hp: 100 + window.state.shopStats.hp,
                atk: 10 + window.state.shopStats.atk, def: 2 + window.state.shopStats.def,
                critChance: 0.05, lifesteal: 0, potions: 3, class: null,
                abilities: { doubleShot: false, shieldBearer: false, resurrection: false, usedResurrection: false, barrier: false, berserker: false, soulReaper: false, bulkUp: false, learningBlade: false, glassCannon: false, investmentExpert: false },
                damageMultiplier: 1.0, weapon: null, armor: null, pants: null, helmet: null, shoes: null, shoulder: null, subWeapon: null,
                weaponRarity: 'COMMON', armorRarity: 'COMMON', pantsRarity: 'COMMON', helmetRarity: 'COMMON', shoesRarity: 'COMMON', shoulderRarity: 'COMMON', subWeaponRarity: 'COMMON',
                modifiers: { 'ëŒ€ì¥ì¥ì´': 0, 'ë‹¬ì¸': 0, 'ê³ ëŒ€': 0 }, skills: []
            };
            window.state.logs = [];
            window.addLog(`íƒ‘ì— ì§„ì…! (${diff})`, 'system');
            spawnEnemy(1, diff, false);
            window.setState('BATTLE');
        };

        window.spawnEnemy = (floorVal, diff, barrierOverride = null) => {
            let mult = diff === 'HARD' ? 1.6 : diff === 'NORMAL' ? 1.3 : 1.0;
            let hp = Math.floor(20 * (1 + floorVal * 0.15) * mult);
            let atk = Math.floor(5 * (1 + floorVal * 0.15) * mult);

            const isGhost = floorVal % 10 !== 0 && Math.random() < 0.15;
            const isMidBoss = floorVal % 10 === 0 && floorVal !== 100;
            
            let name = 'ìŠ¬ë¼ì„', icon = 'ğŸŸ¢';
            
            if (floorVal === 100) { name = 'ë§ˆì™•'; icon = 'ğŸ‘¿'; hp = 1000; atk = 100; }
            else if (isMidBoss) {
                const bosses = [
                    {n:'ì˜¤ìš°ê±° ëŒ€ì¥', i:'ğŸ‘¹', h:60, a:10},
                    {n:'ìì´ì–¸íŠ¸ ìŠ¤íŒŒì´ë”', i:'ğŸ•·ï¸', h:120, a:15},
                    {n:'ë¦¬ì¹˜', i:'ğŸ’€', h:210, a:22},
                    {n:'ê³ ëŒ€ ê³¨ë ˜', i:'ğŸ—¿', h:300, a:30},
                    {n:'ë°ìŠ¤ ë‚˜ì´íŠ¸', i:'âš”ï¸', h:420, a:40}
                ];
                const boss = bosses[Math.min(Math.floor((floorVal-10)/20), bosses.length-1)];
                name = boss.n; icon = boss.i; hp = boss.h; atk = boss.a;
                window.addLog("âš ï¸ ê°•ë ¥í•œ ì¤‘ê°„ ë³´ìŠ¤ ë“±ì¥!", 'warning');
            } else if (isGhost) {
                name = 'ìœ ë ¹'; icon = 'ğŸ‘»'; hp = Math.floor(hp*0.7);
                window.addLog("ğŸ‘» ìœ ë ¹ì´ë‹¤! ë¬¼ë¦¬ ê³µê²© ì£¼ì˜!", 'system');
            } else if (floorVal > 10) { name = 'ê³ ë¸”ë¦°'; icon = 'ğŸ‘º'; hp*=2; atk*=2; } 

            window.enemy = { name, maxHp: hp, hp, atk, def: Math.floor(floorVal * 0.5), img: icon, isGhost };
            
            const isBarrier = barrierOverride !== null ? barrierOverride : window.player.abilities.barrier;
            window.battleState = { barrierTurns: isBarrier ? 1 : 0, turnCount: 1, cooldowns: {}, skillUsage: {} };
            if(isBarrier) window.addLog('ğŸ›¡ï¸ ë°°ë¦¬ì–´ ë°œë™! (1í„´)', 'system');
            
            window.render();
        };

        window.useSkill = (skillIdx) => {
             playerTurn('SKILL', skillIdx);
        };

        window.playerTurn = (action, skillIdx) => {
            if(window.state.gameState !== 'BATTLE') return;

            Object.keys(window.battleState.cooldowns).forEach(k => {
                if(window.battleState.cooldowns[k] > 0) window.battleState.cooldowns[k]--;
            });

            if (action === 'ATTACK') {
                performAttack();
                let hitCount = 1;
                if(window.player.abilities.doubleShot) hitCount *= 2;
                if(window.player.class === 'ê¶ìˆ˜' && window.player.skills.includes(0)) hitCount *= 2;

                if (hitCount > 1) {
                    let hits = 1;
                    const interval = setInterval(() => {
                        if (hits < hitCount && window.enemy.hp > 0) {
                            performAttack(true);
                            hits++;
                            window.render();
                        } else {
                            clearInterval(interval);
                            checkWin();
                        }
                    }, 200);
                } else {
                    setTimeout(checkWin, 500);
                }
            } else if (action === 'SKILL') {
                const skill = window.JOB_SKILLS[window.player.class][skillIdx];
                if(window.battleState.cooldowns[skillIdx] > 0 || (skill.oncePerBattle && window.battleState.skillUsage[skillIdx])) return;

                window.addLog(`âœ¨ ${skill.name}!`, 'win');
                if(skill.cooldown) window.battleState.cooldowns[skillIdx] = skill.cooldown;
                if(skill.oncePerBattle) window.battleState.skillUsage[skillIdx] = true;

                if(skill.effect === 'INVINCIBLE') {
                    window.battleState.barrierTurns = skill.duration;
                    window.addLog(`ë¬´ì  ìƒíƒœ! (${skill.duration}í„´)`, 'system');
                } else if(skill.damageMult) {
                    performAttack(false, skill.damageMult);
                }
                window.showSkillModal = false;
                setTimeout(checkWin, 800);
            } else if (action === 'DEFEND') {
                window.addLog('ë°©ì–´ íƒœì„¸!', 'system');
                setTimeout(() => enemyTurn(true), 800);
            } else if (action === 'POTION') {
                if(window.player.potions > 0) {
                    window.player.potions--;
                    window.player.hp = Math.min(window.player.maxHp, window.player.hp + Math.floor(window.player.maxHp * 0.4));
                    window.addLog('íšŒë³µì•½ ì‚¬ìš©!', 'heal');
                    setTimeout(() => enemyTurn(false), 800);
                } else {
                    window.addLog('ê°€ë°©ì— ì•½ì´ ì—†ë‹¤!', 'error');
                }
            }
            window.render();
        };

        function performAttack(double = false, mult = 1.0) {
            let dmg = Math.max(1, Math.floor((window.player.atk - window.enemy.def) * window.player.damageMultiplier * mult));
            
            if(window.player.abilities.doubleShot) dmg = Math.floor(dmg * 0.65);
            if(window.player.class === 'ê¶ìˆ˜' && window.player.skills.includes(0)) dmg = Math.floor(dmg * 0.6);
            if(window.player.abilities.glassCannon) dmg = Math.floor(dmg * 1.5);
            
            let critRate = window.player.critChance;
            if(window.player.abilities.berserker && (window.player.hp/window.player.maxHp) <= 0.3) critRate += 0.5;
            if(window.player.class === 'ê¶ìˆ˜' && window.player.skills.includes(1)) critRate += 0.3; 
            
            if(Math.random() < critRate && !window.enemy.isGhost) {
                dmg = Math.floor(dmg * 1.5);
                window.addLog(`${window.enemy.name}ì—ê²Œ ${dmg} (ê¸‰ì†Œ!)`, 'player');
            } else {
                window.addLog(`${window.enemy.name}ì—ê²Œ ${dmg} í”¼í•´!`, 'player');
            }
            
            window.enemy.hp = Math.max(0, window.enemy.hp - dmg);
            
            if(window.player.lifesteal > 0) {
                const heal = Math.floor(dmg * window.player.lifesteal);
                if(heal > 0) {
                    window.player.hp = Math.min(window.player.maxHp, window.player.hp + heal);
                }
            }
        }

        function enemyTurn(defending) {
            window.battleState.turnCount++;

            const isOddBarrier = window.player.class === 'ë§ˆë²•ì‚¬' && window.player.skills.includes(3) && (window.battleState.turnCount % 4 === 0);

            if (window.battleState.barrierTurns > 0 || isOddBarrier) {
                if(window.battleState.barrierTurns > 0) {
                    window.battleState.barrierTurns--;
                    window.addLog('ê³µê²©ì„ ë§‰ì•„ëƒˆë‹¤!', 'system');
                } else {
                    window.addLog('ì˜¤ë“œ ë°°ë¦¬ì–´ ë°œë™!', 'system');
                }
                window.render();
                return;
            }

            let dmg = Math.max(0, window.enemy.atk - window.player.def);
            if(defending) dmg = Math.floor(dmg * 0.5);
            if(window.player.abilities.glassCannon) dmg = Math.floor(dmg * 1.3);

            window.player.hp = Math.max(0, window.player.hp - dmg);
            window.addLog(`${window.enemy.name}ì˜ ê³µê²©! ${dmg} í”¼í•´`, 'enemy');

            if (window.player.hp <= 0) {
                if (window.player.abilities.resurrection && !window.player.abilities.usedResurrection) {
                    window.player.hp = Math.floor(window.player.maxHp * 0.5);
                    window.player.abilities.usedResurrection = true;
                    window.addLog('ê¸°ì‚¬íšŒìƒ ë°œë™!', 'win');
                } else {
                    window.setState('GAMEOVER');
                }
            }
            window.render();
        }

        function checkWin() {
            if(window.enemy.hp <= 0) {
                window.addLog(`${window.enemy.name} ì“°ëŸ¬ì¡Œë‹¤!`, 'win');
                let gold = 5;
                if(window.state.difficulty === 'NORMAL') gold = 10;
                if(window.state.difficulty === 'HARD') gold = 15;

                if(window.player.abilities.investmentExpert) gold += 3;
                window.state.totalGold += gold;
                saveGame(); // ê³¨ë“œ ì €ì¥
                window.addLog(`${gold}Gë¥¼ ì–»ì—ˆë‹¤!`, 'system');
                
                if(window.player.abilities.soulReaper) { window.player.maxHp += 5; window.player.hp += 5; }
                if(window.player.abilities.bulkUp) window.player.atk += 3;
                if(window.player.abilities.learningBlade && window.state.floor % 10 === 0 && window.state.floor !== 100) {
                      window.player.maxHp+=50; window.player.hp+=50; window.player.atk+=30; window.player.def+=20;
                      window.addLog('í•™ìŠµí•˜ëŠ” ì¹¼ë‚  íš¨ê³¼!', 'win');
                }

                if(window.state.floor >= MAX_FLOOR) window.setState('VICTORY');
                else {
                    window.state.rerollsLeft = (window.state.floor % 10 === 0) ? 5 : 0;
                    generateAugments();
                    window.setState('AUGMENT');
                }
            } else {
                enemyTurn(false);
            }
            window.render();
        }

        window.handleReroll = () => {
            if(window.state.rerollsLeft > 0) {
                window.state.rerollsLeft--;
                generateAugments();
                window.render();
            }
        };

        window.selectAugment = (idx) => {
            const aug = window.augments[idx];
            aug.action();
            window.addLog(`âœ¨ ${aug.name} íšë“!`, 'system');
            
            const hasBarrier = window.player.abilities.barrier || (aug.name === 'ë°°ë¦¬ì–´');
            
            const nextF = window.state.floor + 1;
            if (nextF === 10 && !window.player.class) {
                window.state.floor = nextF;
                window.setState('CLASS_SELECT');
                return;
            }
            
            if(window.player.class && [10,30,50,70,90].includes(nextF)) {
                const map = {10:0, 30:1, 50:2, 70:3, 90:4};
                const sIdx = map[nextF];
                window.player.skills.push(sIdx);
                const skill = window.JOB_SKILLS[window.player.class][sIdx];
                if(skill.type === 'PASSIVE' && skill.onAcquire) window.player = skill.onAcquire(window.player);
                window.addLog(`ğŸ’¡ ìŠ¤í‚¬ [${skill.name}] ìŠµë“!`, 'win');
            }

            window.state.floor = nextF;
            spawnEnemy(nextF, window.state.difficulty, hasBarrier);
            window.setState('BATTLE');
        };

        window.handleClassSelect = (jobId) => {
             let jobName = 'ê²€ì‚¬';
             if(jobId === 'MAGE') jobName = 'ë§ˆë²•ì‚¬';
             if(jobId === 'ARCHER') jobName = 'ê¶ìˆ˜';
             window.player.class = jobName;
             
             window.player.skills = [0];
             const s1 = window.JOB_SKILLS[jobName][0];
             if(s1.type==='PASSIVE' && s1.onAcquire) window.player = s1.onAcquire(window.player);

             if(jobId === 'WARRIOR') { window.player.atk+=5; window.player.def+=5; window.player.maxHp+=50; window.player.hp+=50; }
             if(jobId === 'MAGE') { window.player.atk+=15; window.player.maxHp+=10; window.player.hp+=10; window.player.potions+=2; }
             if(jobId === 'ARCHER') { window.player.atk+=5; window.player.critChance+=0.2; }

             window.addLog(`${jobName} ì „ì§!`, 'win');
             spawnEnemy(10, window.state.difficulty);
             window.setState('BATTLE');
        };

        window.openSkillModal = () => { window.showSkillModal = true; window.render(); };
        window.closeSkillModal = () => { window.showSkillModal = false; window.render(); };
        window.buyItem = (type, cost) => {
            if(window.state.totalGold >= cost) {
                window.state.totalGold -= cost;
                window.state.shopStats[type]++;
                saveGame(); // êµ¬ë§¤ ì‹œ ì €ì¥
                window.render();
            } else {
                alert('ê³¨ë“œ ë¶€ì¡±');
            }
        };

        // ì´ˆê¸° ì‹¤í–‰
        if (window.render) window.render();

    </script>
</body>
</html>
